{
  "name": "Initial Sync (EvolutionAPI -> Supabase)",
  "nodes": [
    {
      "parameters": {},
      "id": "c5b1a182-2d6d-4a1a-b6e3-aa12efce0c9a",
      "name": "When clicking \"Execute Workflow\"",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -6432,
        16
      ]
    },
    {
      "parameters": {
        "url": "=https://evo.zapneuronz.com.br/instance/fetchInstances",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "841cfe4d-689d-4eb0-acc4-919d85aaa6e1",
      "name": "Fetch Instances",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -6224,
        112
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "wDjVZ1Dbe26c2YVQ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const supabaseData = [];\n// Using the user_id from the user's example as fallback. \n// WARNING: This ID must exist in auth.users for the foreign key constraint to pass.\nconst FALLBACK_USER_ID = '512c51e1-f250-46f0-826f-824ffe112c6a';\n\nfunction mapStatus(status, connectionStatus) {\n    let s = (connectionStatus || status || '').toLowerCase();\n    if (s === 'open' || s === 'connected') return 'connected';\n    if (s === 'close' || s === 'disconnected') return 'disconnected';\n    if (s === 'connecting') return 'connecting';\n    if (s === 'qr' || s === 'qrcode') return 'qr_code';\n    return 'disconnected';\n}\n\nfunction processInstance(inst) {\n    const name = inst.instanceName || inst.name;\n    \n    if (name) {\n        const now = new Date().toISOString();\n        const instanceDate = inst.updatedAt || inst.createdAt || now;\n        \n        supabaseData.push({\n            name: name,\n            evolution_instance_id: inst.instanceId || inst.id || inst.name,\n            phone: inst.phoneNumber || (inst.ownerJid && inst.ownerJid.includes('@') ? inst.ownerJid.split('@')[0].split(':')[0] : (inst.owner && !inst.owner.includes('@') ? inst.owner : null)),\n            status: mapStatus(inst.status, inst.connectionStatus),\n            qr_code: inst.qrcode || inst.base64 || null,\n            profile_pic_url: inst.profilePicUrl || inst.profilePictureUrl || null,\n            webhook_url: inst.webhook || (inst.webhookUrl ? inst.webhookUrl : null),\n            settings: (inst.Setting || inst.settings) ? JSON.stringify(inst.Setting || inst.settings) : null,\n            last_seen: instanceDate,\n            user_id: inst.owner || inst.user_id || FALLBACK_USER_ID,\n            created_at: inst.createdAt || now,\n            updated_at: now\n        });\n    }\n}\n\nfor (const item of items) {\n    const data = item.json;\n    if (Array.isArray(data)) {\n        for (const subItem of data) {\n            processInstance(subItem.instance || subItem);\n        }\n    } else {\n        processInstance(data.instance || data);\n    }\n}\n\nreturn [{ json: { data: supabaseData } }];"
      },
      "id": "207b51e6-1632-49ab-9089-1ae70fa13412",
      "name": "Prepare Instance Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5968,
        32
      ]
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "1bd02c36-c384-4d48-a8db-9849f6e265d6",
      "name": "Split Instances",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -5632,
        -16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evo.zapneuronz.com.br/chat/findContacts/{{ $json.name }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "27d3e73e-2d1b-4493-9e39-84d6aa3881db",
      "name": "Get Contacts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -5440,
        -80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "wDjVZ1Dbe26c2YVQ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://evo.zapneuronz.com.br/group/fetchAllGroups/{{ $json.name }}?getParticipants=false",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "23b9bd08-ebdf-4553-ab96-04f72d8b7faf",
      "name": "Get Groups",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -5440,
        144
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "wDjVZ1Dbe26c2YVQ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "instance_id",
              "value": "={{ $('Split Instances').item.json.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d8135093-4c16-4c12-b9d4-3c22a2ef032a",
      "name": "Add Instance ID Contacts",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -5312,
        -64
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "instance_id",
              "value": "={{ $('Split Instances').item.json.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "44d3bebd-6350-4e33-ab4c-a79b728d9c5c",
      "name": "Add Instance ID Groups",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -5280,
        128
      ]
    },
    {
      "parameters": {},
      "id": "7eac93c6-80a5-43fe-ba3a-ea33bffb92c0",
      "name": "Merge Contacts & Groups",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        -5120,
        -48
      ]
    },
    {
      "parameters": {
        "jsCode": "// Use $input.all() to get all items from the Merge node (Append mode)\nconst items = $input.all();\n\nif (items.length === 0) return [];\n\n// Extract instanceId from the first item. \n// Prioritize 'instance_id' (injected Supabase ID) over 'instanceId' (Evolution ID).\nlet instanceId = items[0].json.instance_id;\n\n// Fallback: Try to get it directly from Split Instances node if missing in items\nif (!instanceId) {\n    try {\n        instanceId = $('Split Instances').first().json.id;\n    } catch (e) {\n        // ignore\n    }\n}\n\nif (!instanceId) {\n    throw new Error(`Instance ID is missing! Value: ${instanceId}, keys: ${Object.keys(items[0].json).join(', ')}`);\n}\n\nconst contactsMap = {};\n\nfunction getPhone(item) {\n    if (item.phoneNumber) return item.phoneNumber;\n    // Removed item.number check as it seems to be an internal ID\n    \n    // Prioritize explicit JID fields\n    const jid = item.remoteJid || item.jid;\n    if (jid && jid.includes('@')) {\n        return jid.split('@')[0].split(':')[0];\n    }\n    \n    // Fallback to id only if it looks like a JID\n    if (item.id && item.id.includes('@')) {\n        return item.id.split('@')[0].split(':')[0];\n    }\n    \n    return null;\n}\n\nitems.forEach((itemObj, index) => {\n    const item = itemObj.json;\n    const id = item.remoteJid || item.id || item.jid;\n    const phone = getPhone(item);\n    if (!phone) return;\n\n    const isGroup = item.type === 'group' || item.isGroup === true || (id && id.includes('@g.us'));\n    const pic = item.profilePicUrl || item.profilePictureUrl || null;\n    \n    // Determine name properties\n    // Groups usually have 'subject'. Contacts have 'name', 'pushName', 'notify'.\n    const name = item.subject || item.name || item.pushName || item.notify || phone;\n    const pushName = item.pushName || item.notify || item.subject;\n\n    // JID User (Raw Number) for internal mapping\n    const jidUser = (id && id.includes('@')) ? id.split('@')[0].split(':')[0] : phone;\n\n    if (!contactsMap[phone]) {\n        contactsMap[phone] = {\n            json: {\n                phone: phone,\n                jid_user: jidUser,\n                name: name,\n                push_name: pushName,\n                profile_pic_url: pic,\n                is_group: isGroup,\n                group_metadata: isGroup ? item : null,\n                instance_id: instanceId\n            },\n            // Pair with the current input item to preserve lineage as much as possible,\n            // or pair with the first item [0] if we want to treat them all as children of the batch.\n            // Since we are aggregating, pairing with 0 is safer for the 'Split Instances' reference.\n            pairedItem: { item: 0 }\n        };\n    } else {\n        const existing = contactsMap[phone].json;\n        \n        // Update profile pic if new one is present\n        if (pic) existing.profile_pic_url = pic;\n        \n        // Update name if we found a better one (e.g. not just the phone number)\n        if (name && name !== phone) existing.name = name;\n        \n        // If it's a group, ensure is_group is true and update metadata if this item looks like it has more info (e.g. subject)\n        if (isGroup) {\n            existing.is_group = true;\n            if (item.subject || item.participants) {\n                existing.group_metadata = item;\n            }\n        }\n    }\n});\n\nreturn Object.values(contactsMap);"
      },
      "id": "9824feb5-f830-481d-bb21-d5636c399137",
      "name": "Normalize Contacts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5008,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://agsvbhzvlwygpnxygtnt.supabase.co/rest/v1/contacts?on_conflict=phone,instance_id",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ Object.fromEntries(Object.entries($json).filter(([k]) => !['jid_user', 'pairedItem'].includes(k))) }}",
        "options": {}
      },
      "id": "8ca682ba-2e06-4287-8884-32dc6ae01895",
      "name": "Upsert Contacts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -4768,
        32
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5giRdkHvRJY0ru7a",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst normalizeItems = $('Normalize Contacts').all();\nconst contactMap = {};\n\nitems.forEach((item, index) => {\n    const contact = item.json;\n    \n    // Retrieve jid_user from the corresponding item in Normalize Contacts\n    // We assume the order is preserved (n8n usually preserves order in HTTP Request)\n    const originalItem = normalizeItems[index]?.json;\n    const jidUser = originalItem?.jid_user;\n    const phone = originalItem?.phone;\n    \n    // Use jid_user (raw number) as key for reliable lookup from chats\n    const key = jidUser || phone;\n    \n    if (key && contact.id) {\n        contactMap[key] = {\n            id: contact.id,\n            profile_pic_url: contact.profile_pic_url,\n            name: contact.name,\n            push_name: contact.push_name,\n            is_group: contact.is_group\n        };\n    }\n});\n\n// Restore instance info for next nodes\nconst instanceName = $('Split Instances').item.json.name;\nconst instanceId = $('Split Instances').item.json.id;\n\nreturn [{\n    json: {\n        contactMap: contactMap,\n        instanceName: instanceName,\n        instanceId: instanceId\n    }\n}];"
      },
      "id": "4cc6f455-8529-4b14-93d4-d77a8d509438",
      "name": "Create Contact Map",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4544,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evo.zapneuronz.com.br/chat/findChats/{{ $json.instanceName.trim() }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "7cab6b88-e2e2-4d9f-be5f-5b1202ba764a",
      "name": "Get Chats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -4336,
        32
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "wDjVZ1Dbe26c2YVQ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const instanceId = $('Create Contact Map').first().json.instanceId;\n// FIX: Use .first() instead of .item because Create Contact Map returns a single aggregated item\nconst contactMap = $('Create Contact Map').first().json.contactMap;\nconst chats = $input.all().map(i => i.json);\n\nconst normalizedChats = [];\n\n// DEBUG: Check if map is populated\nconst mapKeys = Object.keys(contactMap || {});\nif (mapKeys.length === 0) {\n    throw new Error(\"Contact Map is empty!\");\n}\n\nchats.forEach(chat => {\n    if (Array.isArray(chat)) {\n        chat.forEach(c => processChat(c));\n    } else {\n        processChat(chat);\n    }\n});\n\nfunction processChat(c) {\n    // IMPORTANT: Use remoteJid (WhatsApp chat ID), NOT id (Evolution's internal ID)\n    let remoteJid = c.remoteJid || c.id;\n    if (!remoteJid) return;\n    \n    // Handle LID: try to find the real phone number from lastMessage if available\n    // LID JIDs (e.g. 12345@lid) don't map to phone numbers directly, but the last message might have the alt JID\n    if (remoteJid.includes('@lid') && c.lastMessage?.key?.remoteJidAlt) {\n        remoteJid = c.lastMessage.key.remoteJidAlt;\n    }\n    \n    const phone = remoteJid.split('@')[0].split(':')[0];\n    \n    // Get contact ID from map (now contains object {id, profile_pic_url, name, push_name, is_group})\n    const contactData = contactMap[phone];\n    const contactId = contactData ? contactData.id : null;\n    \n    // Fallback for Name: Contact Map -> Chat Name -> Chat PushName -> Chat Subject -> Phone\n    const contactName = contactData?.name || contactData?.push_name || c.name || c.pushName || c.subject || phone;\n    \n    // Fallback for Group status\n    const isGroup = contactData ? contactData.is_group : (remoteJid.includes('@g.us'));\n    \n    // Fallback for Profile Pic: Contact Map -> Chat ProfilePic -> Chat Image -> Nested Contact/User\n    const profilePic = contactData?.profile_pic_url || \n                       c.profilePictureUrl || \n                       c.image || \n                       c.contact?.profilePictureUrl || \n                       c.user?.profilePictureUrl || \n                       null;\n    \n    // DEBUG: Log first failure\n    if (!contactId && normalizedChats.length === 0) {\n         // throw new Error(`Debug: Phone ${phone} not found in map. Map keys sample: ${mapKeys.slice(0, 5).join(', ')}`);\n    }\n    \n    // Extract last message content\n    const lastMsgObj = c.lastMessage;\n    const content = lastMsgObj?.message?.conversation || \n                    lastMsgObj?.message?.extendedTextMessage?.text || \n                    lastMsgObj?.message?.imageMessage?.caption || \n                    (lastMsgObj ? 'Media/Other' : null);\n\n    // Format Date\n    // Try conversationTimestamp, then lastMessage timestamp, then t (epoch), then now\n    const ts = c.conversationTimestamp || c.lastMessage?.messageTimestamp || c.t;\n    const dateObj = ts ? new Date(ts * 1000) : new Date();\n    const lastTimeFormatado = dateObj.toLocaleString('pt-BR'); \n\n    normalizedChats.push({\n        chat_id: remoteJid,\n        instance_id: instanceId,\n        contact_id: contactId,\n        unread_count: c.unreadCount || 0,\n        last_message_time: dateObj.toISOString(),\n        last_message: content,\n        \n        // New Fields\n        phone_contact: phone,\n        grupo: isGroup,\n        nome_contato: contactName || phone,\n        last_time_formatado: lastTimeFormatado,\n        url_foto_perfil: profilePic,\n        participant_name: contactName || phone // Using contact name as participant name for the chat\n    });\n}\n\n// DEBUG: Throw error to see output\n// const sample = normalizedChats.find(c => c.contact_id === null);\n// if (sample) {\n//    throw new Error(`Failed to map contact! Chat: ${sample.chat_id}, Phone: ${sample.chat_id.split('@')[0]}, Map Sample: ${mapKeys.slice(0, 5)}`);\n// }\n\nreturn normalizedChats;"
      },
      "id": "26dcadd8-98b6-43ea-8dd2-70a534f71246",
      "name": "Normalize Chats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4112,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://agsvbhzvlwygpnxygtnt.supabase.co/rest/v1/chats?on_conflict=chat_id,instance_id",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "2e3f24ae-3483-46b9-bdcc-ff75dfc3ce1d",
      "name": "Upsert Chats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -3888,
        32
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5giRdkHvRJY0ru7a",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const instanceName = $('Create Contact Map').first().json.instanceName;\nconst items = $input.all();\nconst chatMap = {};\n\nreturn items.map((item, index) => {\n    // Supabase returns an array of inserted rows, take the first one\n    const c = Array.isArray(item.json) ? item.json[0] : item.json;\n    chatMap[c.chat_id] = c.id;\n    c.instanceName = instanceName;\n    return {\n        json: c,\n        pairedItem: { item: index }\n    };\n});"
      },
      "id": "92ace874-26d4-4f53-9220-ede629064e7f",
      "name": "Create Chat Map",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3664,
        32
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7c02334d-989a-492c-92cd-34650d2ac728",
      "name": "Split Chats",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -3456,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://evo.zapneuronz.com.br/chat/findMessages/{{ $('Split Chats').item.json.instanceName }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"where\": { \"key\": { \"remoteJid\": $('Split Chats').item.json.chat_id } }, \"options\": { \"limit\": 50, \"page\": 1 } } }}",
        "options": {}
      },
      "id": "b8914d92-bc2b-4864-84bc-84a5cb5c3be1",
      "name": "Get Messages",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -3216,
        32
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "wDjVZ1Dbe26c2YVQ",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const instanceId = $('Create Contact Map').first().json.instanceId;\nconst chatUuid = $('Split Chats').item.json.id;\nconst chatRemoteJid = $('Split Chats').item.json.chat_id;\nconst contactMapData = $('Create Contact Map').first().json.contactMap;\nconst items = $input.all();\n\nconst normalizedMessages = [];\n\n// Map Evolution API message types to database-valid types\nfunction mapMessageType(evoType) {\n    const typeMap = {\n        'conversation': 'text',\n        'extendedTextMessage': 'text',\n        'imageMessage': 'image',\n        'videoMessage': 'video',\n        'audioMessage': 'audio',\n        'documentMessage': 'document',\n        'stickerMessage': 'sticker',\n        'locationMessage': 'location',\n        'contactMessage': 'contact',\n        'protocolMessage': 'system',\n        'ephemeralMessage': 'system',\n        'ptvMessage': 'video'\n    };\n    return typeMap[evoType] || 'text';\n}\n\nitems.forEach((itemObj, index) => {\n    const data = itemObj.json;\n    \n    // Handle Evolution API paginated response structure\n    let messages = [];\n    if (data.messages && data.messages.records) {\n        // Paginated response: { messages: { records: [...] } }\n        messages = data.messages.records;\n    } else if (Array.isArray(data)) {\n        // Direct array\n        messages = data;\n    } else {\n        // Single message object\n        messages = [data];\n    }\n    \n    messages.forEach(m => processMessage(m, index));\n});\n\nfunction processMessage(m, parentIndex) {\n    const key = m.key || {};\n    const messageId = key.id;\n    if (!messageId) return;\n    \n    // Extract participant\n    // For group chats, participant is in key.participant\n    // For direct chats, it might be key.remoteJid (if not from me)\n    let participant = key.participant || key.remoteJid;\n    \n    // If participant has @lid, we might want to use participantAlt (phone number) if available\n    // But usually the contact map is keyed by phone number (user ID part of JID)\n    if (key.participantAlt) {\n        participant = key.participantAlt;\n    }\n    \n    const participantPhone = participant ? participant.split('@')[0].split(':')[0] : null;\n    \n    // Get contact data from map (now contains id and profile_pic_url)\n    const contactData = participantPhone ? contactMapData[participantPhone] : null;\n    const contactId = contactData ? contactData.id : null;\n    const thumbnailPath = contactData ? contactData.profile_pic_url : null;\n    \n    const content = m.message?.conversation || m.message?.extendedTextMessage?.text || m.message?.imageMessage?.caption || 'Media/Other';\n    \n    // Get the raw message type from Evolution API\n    const rawType = Object.keys(m.message || {})[0] || 'conversation';\n    const messageType = mapMessageType(rawType);\n    \n    // Extract media info if available\n    let mediaUrl = null;\n    let mediaPath = null;\n    let mediaSize = null;\n    let mediaMimeType = null;\n    \n    const mediaMsg = m.message?.[rawType];\n    if (mediaMsg && typeof mediaMsg === 'object') {\n        mediaUrl = mediaMsg.url || null;\n        mediaPath = mediaMsg.directPath || null;\n        mediaSize = mediaMsg.fileLength?.low || mediaMsg.fileLength || null;\n        mediaMimeType = mediaMsg.mimetype || null;\n    }\n\n    // Extract quoted message ID\n    const contextInfo = m.message?.[rawType]?.contextInfo || m.contextInfo;\n    const quotedMessageId = contextInfo?.stanzaId || null;\n    \n    // Construct Metadata object\n    const metadata = {\n        media: (mediaUrl || mediaPath || mediaMimeType) ? {\n            url: mediaUrl,\n            path: mediaPath,\n            mimetype: mediaMimeType\n        } : null,\n        sticker: m.message?.stickerMessage || null,\n        location: m.message?.locationMessage || null,\n        pushName: m.pushName || null,\n        rawMessage: m,\n        webhookSource: 'evolution'\n    };\n\n    normalizedMessages.push({\n        json: {\n            message_id: messageId,\n            chat_id: chatRemoteJid,\n            chat_table_id: chatUuid,\n            contact_id: contactId,\n            instance_id: instanceId,\n            content: content,\n            from_me: key.fromMe || false,\n            timestamp_msg: (m.messageTimestamp || m.t) ? new Date((m.messageTimestamp || m.t) * 1000).toISOString() : new Date().toISOString(),\n            status: m.status || 'delivered',\n            message_type: messageType,\n            thumbnail_path: thumbnailPath,\n            media_url: mediaUrl,\n            media_path: mediaPath,\n            media_size: mediaSize,\n            media_mime_type: mediaMimeType,\n            quoted_message_id: quotedMessageId,\n            participant: participant, // Populate the participant column\n            metadata: metadata // Populate the metadata column\n        },\n        pairedItem: { item: parentIndex }\n    });\n}\n\nreturn normalizedMessages;"
      },
      "id": "23ffed32-1c95-4140-af45-e28cbc5b5f61",
      "name": "Normalize Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://agsvbhzvlwygpnxygtnt.supabase.co/rest/v1/messages?on_conflict=message_id,chat_id",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "dd582ac3-2cb5-4cae-b40e-e2e9ffb5a137",
      "name": "Upsert Messages",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -2784,
        32
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5giRdkHvRJY0ru7a",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://agsvbhzvlwygpnxygtnt.supabase.co/rest/v1/instances?name=eq.Comercial",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.data }}",
        "options": {}
      },
      "id": "9cc31d45-f958-4458-b7cf-21e56f4c172f",
      "name": "Get Instances",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -5808,
        240
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5giRdkHvRJY0ru7a",
          "name": "Supabase account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking \"Execute Workflow\"": {
      "main": [
        [
          {
            "node": "Fetch Instances",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Instances": {
      "main": [
        [
          {
            "node": "Prepare Instance Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Instance Data": {
      "main": [
        [
          {
            "node": "Get Instances",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Instances": {
      "main": [
        [],
        [
          {
            "node": "Get Contacts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Groups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Contacts": {
      "main": [
        [
          {
            "node": "Add Instance ID Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Groups": {
      "main": [
        [
          {
            "node": "Add Instance ID Groups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Instance ID Contacts": {
      "main": [
        [
          {
            "node": "Merge Contacts & Groups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Instance ID Groups": {
      "main": [
        [
          {
            "node": "Merge Contacts & Groups",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Contacts & Groups": {
      "main": [
        [
          {
            "node": "Normalize Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Contacts": {
      "main": [
        [
          {
            "node": "Upsert Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Contacts": {
      "main": [
        [
          {
            "node": "Create Contact Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Contact Map": {
      "main": [
        [
          {
            "node": "Get Chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Chats": {
      "main": [
        [
          {
            "node": "Normalize Chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Chats": {
      "main": [
        [
          {
            "node": "Upsert Chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Chats": {
      "main": [
        [
          {
            "node": "Create Chat Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Chat Map": {
      "main": [
        [
          {
            "node": "Split Chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Chats": {
      "main": [
        [],
        [
          {
            "node": "Get Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Messages": {
      "main": [
        [
          {
            "node": "Normalize Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Messages": {
      "main": [
        [
          {
            "node": "Upsert Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Messages": {
      "main": [
        [
          {
            "node": "Split Chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Instances": {
      "main": [
        [
          {
            "node": "Split Instances",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d7947930-0f23-4359-aba3-a2b85dd47ec9",
  "meta": {
    "instanceId": "028b54764a5e82c8feecad5f0f0b75a6ce3b8ee71394c70dfbaeff0ffd685c7c"
  },
  "id": "e6CHm52XuKdrB9Mm",
  "tags": []
}